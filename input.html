<!DOCTYPE html>
<html lang="id">
<head>
    <title>Input Data PCR & SLA</title>
    <link rel="stylesheet" href="style.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            color: #333;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        
        .input-form {
            margin: 20px 0;
            padding: 20px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 0 5px rgba(0,0,0,0.05);
        }
        .input-group {
            margin-bottom: 15px;
        }
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #49502c;
        }
        .input-group input, 
        .input-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            box-sizing: border-box;
        }
        .date-picker-wrapper {
            position: relative;
        }
        .date-picker-wrapper input[type="date"] {
            position: absolute;
            right: 0;
            top: 0;
            width: 40px;
            height: 40px;
            opacity: 0;
            cursor: pointer;
        }
        .date-picker-wrapper::after {
            content: "ðŸ“…";
            position: absolute;
            right: 10px;
            top: 10px;
            pointer-events: none;
            font-size: 20px;
        }
        .submit-btn {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            margin-top: 10px;
            transition: background-color 0.3s;
        }
        .submit-btn:hover {
            background-color: #45a049;
        }
        .status-message {
            margin-top: 15px;
            padding: 10px;
            border-radius: 4px;
            display: none;
        }
        .success {
            background-color: #dff0d8;
            color: #3c763d;
            border: 1px solid #d6e9c6;
        }
        .error {
            background-color: #f2dede;
            color: #a94442;
            border: 1px solid #ebccd1;
        }
        .my-button:hover {
            background-color: #2980b9;
        }
        
    </style>
</head>
<body>
    <div class="container">
        <h1>Status PCR & SLA</h1>
        
        <div class="input-form">
            <div class="input-group">
                <label for="inputA">Doc Received Date</label>
                <div class="date-picker-wrapper">
                    <input type="text" id="inputA" placeholder="YYYY-MM-DD" maxlength="10">
                    <input type="date" id="datePicker" onchange="setDateFromPicker(this.value)">
                </div>
            </div>

            <div class="input-group">
                <p1 id="latestDate"></p1>
            </div>

            <div class="input-group">
                <label for="inputA1">Angka Khusus</label>
                <input type="text" id="inputA1" placeholder="Tidak wajib, hanya apabila ada tanggal yang sama (dimulai dari 2, max 9)" maxlength="1">
            </div>
            
            <div class="input-group">
                <label for="inputB">PCR/SLA Control No.</label>
                <input type="text" id="inputB" required>
            </div>
            
            <div class="input-group">
                <label for="inputC">Supplier Name</label>
                <select id="inputC" required>
                    <option value="">Pilih Supplier</option>
                    <option value="AISAN NASMOCO INDUSTRI">AISAN NASMOCO INDUSTRI</option>
                    <option value="AISIN INDONESIA">AISIN INDONESIA</option>
                    <option value="AISIN INDONESIA OTOMOTIF">AISIN INDONESIA OTOMOTIF</option>
                    <option value="AOYAMA INDONESIA">AOYAMA INDONESIA</option>
                    <option value="ART PISTON INDONESIA">ART PISTON INDONESIA</option>
                    <option value="ASSB MALAYSIA">ASSB MALAYSIA</option>
                    <option value="ASTRA NIPPON GASKET INDONESIA">ASTRA NIPPON GASKET INDONESIA</option>
                    <option value="AT INDONESIA">AT INDONESIA</option>
                    <option value="AUTOMOTIVE FASTENERS AOYAMA INDONESIA">AUTOMOTIVE FASTENERS AOYAMA INDONESIA</option>
                    <option value="CATALER">CATALER</option>
                    <option value="DENSO INDONESIA CORPORATION (FAJAR)">DENSO INDONESIA CORPORATION (FAJAR)</option>
                    <option value="DIAMOND DELECTRIC INDONESIA">DIAMOND DELECTRIC INDONESIA</option>
                    <option value="FUKOKU TOKAI RUBBER">FUKOKU TOKAI RUBBER</option>
                    <option value="FUTABA INDONESIA">FUTABA INDONESIA</option>
                    <option value="HITACHI">HITACHI</option>
                    <option value="ITOKIN">ITOKIN</option>
                    <option value="METALART ASTRA INDONESIA">METALART ASTRA INDONESIA</option>
                    <option value="NICHIAS SUNIJAYA">NICHIAS SUNIJAYA</option>
                    <option value="NOK INDONESIA">NOK INDONESIA</option>
                    <option value="OTICS INDONESIA">OTICS INDONESIA</option>
                    <option value="PAKAR TIRIKEN INDONESIA">PAKAR TIRIKEN INDONESIA</option>
                    <option value="PARIN">PARIN</option>
                    <option value="PATEC PRESISI ENGINEERING">PATEC PRESISI ENGINEERING</option>
                    <option value="ROBERT BOSCH">ROBERT BOSCH</option>
                    <option value="SARI TAKAGI ELOK PRODUK">SARI TAKAGI ELOK PRODUK</option>
                    <option value="SIAM THAILAND MOTOR">SIAM THAILAND MOTOR</option>
                    <option value="SUMIDEN SINTERED COMPONENT INDONESIA">SUMIDEN SINTERED COMPONENT INDONESIA</option>
                    <option value="SUNCHIRIN INDUSTRI INDONESIA">SUNCHIRIN INDUSTRI INDONESIA</option>
                    <option value="TAIHO NUSANTARA">TAIHO NUSANTARA</option>
                    <option value="TB-INA">TB-INA</option>
                    <option value="TOYOTA BOSHOKU INDONESIA">TOYOTA BOSHOKU INDONESIA</option>
                    <option value="TPR SALES INDONESIA">TPR SALES INDONESIA</option>
                    <option value="VELASTO INDONESIA">IVELASTO INDONESIA</option>
                    <option value="YASUNAGA INDONESIA">YASUNAGA INDONESIA</option>
                    <option value="#NA">#NA</option>
                </select>
            </div>

            <div class="input-group">
                <label for="inputD">Part Number</label>
                <input type="text" id="inputD" placeholder="12345-12345-AB" maxlength="14" required>
            </div>

            <div class="input-group">
                <label for="inputE">Part Name</label>
                <input type="text" id="inputE" required>
            </div>

            <div class="input-group">
                <label for="inputF">Change Category</label>
                <select id="inputF" required>
                    <option value="">Pilih Kategori</option>
                    <option value="Add Supplier">Add Supplier</option>
                    <option value="Capacity">Capacity</option>
                    <option value="Change Supplier">Change Supplier</option>
                    <option value="Cost">Cost</option>
                    <option value="Govt Regulation">Govt Regulation</option>
                    <option value="Localization">Localization</option>
                    <option value="Mfg/Storage Loc">Mfg/Storage Loc</option>
                    <option value="Productivity">Productivity</option>
                    <option value="Quality">Quality</option>
                    <option value="Risk Mgmt">Risk Mgmt</option>
                    <option value="Other">Other</option>
                </select>
            </div>

            <div class="input-group">
                <label for="inputG">Previous Process</label>
                <input type="text" id="inputG" required>
            </div>

            <div class="input-group">
                <label for="inputH">New Process</label>
                <input type="text" id="inputH" required>
            </div>
            <div id="statusMessage" class="status-message"></div>
            <button id="submitBtn" class="submit-btn">Enter Data</button>
            
            
        </div>
        
        <p>Apabila ada kendala, segera sampaikan ke tim Quality Control</p>
        <div class="button-container">
            <a href="index.html" class="my-button">Kembali ke Home</a>
            <a href="input.html" class="my-button2"></a>
            <a href="view2.html" class="my-button">Lihat Status</a>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
    
    <script>
        // Konfigurasi Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDB31VI5CjfiLPwD5njBa2tVHz_UXipNH0",
            authDomain: "pcr-sla-28728.firebaseapp.com",
            databaseURL: "https://pcr-sla-28728-default-rtdb.firebaseio.com",
            projectId: "pcr-sla-28728",
            storageBucket: "pcr-sla-28728.appspot.com",
            messagingSenderId: "738065802011",
            appId: "1:738065802011:web:28f865a4cb84a76f0a69be",
            measurementId: "G-NE5XL3LRJ8"
        };

        // Inisialisasi Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Format input tanggal (YYYY-MM-DD)
        function formatDateInput() {
            const input = document.getElementById('inputA');
            let value = input.value.replace(/[^\d]/g, '');
            
            if (value.length > 4) {
                value = value.substring(0, 4) + '-' + value.substring(4);
            }
            if (value.length > 7) {
                value = value.substring(0, 7) + '-' + value.substring(7);
            }
            
            input.value = value.substring(0, 10);
        }

        // Validasi input angka khusus (minimal 2)
        function formatInput() {
            const input = document.getElementById('inputA1');
            let value = input.value.replace(/[^\d]/g, '');
            
            if (value.length > 0) {
                const num = parseInt(value, 10);
                if (num < 2) {
                    value = '';
                    showStatus('Angka khusus harus minimal 2', 'error');
                }
            }
            
            value = value.substring(0, 2);
            input.value = value;
        }

        // Set tanggal dari date picker
        function setDateFromPicker(dateValue) {
            if (dateValue) {
                const date = new Date(dateValue);
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                document.getElementById('inputA').value = `${year}-${month}-${day}`;
            }
        }

        // Format part number (12345-12345-AB)
        function formatPartNumberInput() {
            const input = document.getElementById('inputD');
            let value = input.value.toUpperCase();
            value = value.replace(/[^A-Z0-9-]/g, '');
            const valueWithoutHyphens = value.replace(/-/g, '');
            let formattedValue = valueWithoutHyphens;

            if (valueWithoutHyphens.length > 5) {
                formattedValue = valueWithoutHyphens.substring(0, 5) + '-' + valueWithoutHyphens.substring(5);
            }
            if (valueWithoutHyphens.length > 10) {
                formattedValue = formattedValue.substring(0, 11) + '-' + formattedValue.substring(11);
            }
            input.value = formattedValue.substring(0, 14);
        }

        // Ambil tanggal terbaru dari Firebase
        function getLatestDateFromFirebase() {
            const ref = database.ref();
            ref.once('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    const keys = Object.keys(data).filter(k => /^\d{4}-\d{2}-\d{2}/.test(k));
                    keys.sort();
                    const latestKey = keys[keys.length - 1];
                    document.getElementById('latestDate').textContent = 'Tanggal Data Terbaru : ' + latestKey;
                } else {
                    document.getElementById('latestDate').textContent = 'Belum ada data.';
                }
            });
        }

        // Tampilkan pesan status
        function showStatus(message, type) {
            const statusElement = document.getElementById('statusMessage');
            statusElement.textContent = message;
            statusElement.className = 'status-message ' + type;
            statusElement.style.display = 'block';
            
            setTimeout(() => {
                statusElement.style.display = 'none';
            }, 3000);
        }

        // Simpan data ke Firebase dengan validasi unik
        function saveData() {
            const inputA = document.getElementById('inputA').value.trim();
            const inputA1 = document.getElementById('inputA1').value.trim();
            const inputB = document.getElementById('inputB').value.trim();
            const inputC = document.getElementById('inputC').value;
            const inputD = document.getElementById('inputD').value.trim();
            const inputE = document.getElementById('inputE').value.trim();
            const inputF = document.getElementById('inputF').value;
            const inputG = document.getElementById('inputG').value.trim();
            const inputH = document.getElementById('inputH').value.trim();

            // Validasi input
            if (!inputA || !inputB || !inputC || !inputD || !inputE || !inputF || !inputG || !inputH) {
                showStatus('Semua field harus diisi!', 'error');
                return;
            }

            // Validasi format tanggal
            const dateRegex = /^\d{4}-\d{2}-\d{2}$/;
            if (!dateRegex.test(inputA)) {
                showStatus('Format tanggal harus YYYY-MM-DD!', 'error');
                return;
            }

            // Buat key unik
            const key = inputA1 ? `${inputA}(${inputA1})` : inputA;

            // Cek apakah key sudah ada
            database.ref(key).once('value')
                .then((snapshot) => {
                    if (snapshot.exists()) {
                        if (!inputA1) {
                            showStatus('Tanggal sudah ada, silahkan menambahkan angka khusus', 'error');
                        } else {
                            showStatus('Kombinasi tanggal dan angka khusus sudah ada', 'error');
                        }
                        return Promise.reject('Key sudah ada');
                    }

                    // Data untuk disimpan
                    const dataToSave = {
                        B: inputB,
                        C: inputC,
                        D: inputD,
                        E: inputE,
                        F: inputF,
                        G: inputG,
                        H: inputH,
                        I: '', // sample part
                        J: '', // special job
                        K: '', // trial date
                        L: '', // trial report number
                        M: '', // trial report result
                        P: '', // mas pro report number
                        status: 'New',
                        notes: '',
                        notes2: '',
                        timestamp: firebase.database.ServerValue.TIMESTAMP
                    };

                    return database.ref(key).set(dataToSave);
                })
                .then(() => {
                    showStatus('Data berhasil disimpan!', 'success');
                    // Reset form
                    document.getElementById('inputA').value = '';
                    document.getElementById('inputA1').value = '';
                    document.getElementById('inputB').value = '';
                    document.getElementById('inputC').value = '';
                    document.getElementById('inputD').value = '';
                    document.getElementById('inputE').value = '';
                    document.getElementById('inputF').value = '';
                    document.getElementById('inputG').value = '';
                    document.getElementById('inputH').value = '';
                    
                    // Update tanggal terbaru
                    getLatestDateFromFirebase();
                })
                .catch((error) => {
                    if (error !== 'Key sudah ada') {
                        showStatus('Error: ' + error.message, 'error');
                    }
                });
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            getLatestDateFromFirebase();
            
            document.getElementById('inputA').addEventListener('input', formatDateInput);
            document.getElementById('inputD').addEventListener('input', formatPartNumberInput);
            document.getElementById('inputA1').addEventListener('input', formatInput);
            document.getElementById('submitBtn').addEventListener('click', saveData);
            
            document.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    saveData();
                }
            });
        });
    </script>
</body>
</html>