<!DOCTYPE html>
<html>
<head>
    <title>Status PCR & SLA</title>
    <link rel="stylesheet" href="style.css">
    <!-- Sertakan Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
    <!-- Sertakan Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* CSS yang sama seperti sebelumnya */
        body {
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
            margin: 0;
            padding: 0;
        }
        
        .container {
            max-width: 95%;
            margin: 20px auto;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            text-align: center;
            color: #333;
        }
        
        /* Table Scroll Container */
        .table-scroll-container {
            position: relative;
            width: 100%;
            margin: 20px 0;
        }
        
        .table-scroll-top {
            width: 100%;
            height: 20px;
            overflow-x: auto;
            overflow-y: hidden;
            margin-bottom: 5px;
        }
        
        .table-scroll-top-inner {
            height: 1px;
        }
        
        .table-container {
            width: 100%;
            overflow-x: auto;
            margin: 0;
        }
        
        table {
            width: 200%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
            font-size: 10px;
        }
        
        th {
            background-color: #ff0000;
            color: white;
            white-space: nowrap;
            position: sticky;
            top: 0;
        }
        
        tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        
        .edit-select {
            width: 100%;
            padding: 6px;
            box-sizing: border-box;
            margin-bottom: 6px;
            font-size: 9px;
        }
        
        .edit-input {
            width: 100%;
            padding: 6px;
            box-sizing: border-box;
            margin-bottom: 6px;
            font-size: 9px;
        }
        
        .save-btn {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
            font-size: 13px;
        }
        
        .save-btn:hover {
            background-color: #45a049;
        }
        
        .status-new {
            background-color: #6cc6f3;
            color: #28556b;
            font-weight: bold;
        }
        
        .status-done {
            background-color: #86ff56;
            color: #325a32;
            font-weight: bold;
        }
        
        .status-ongoing {
            background-color: #f9fbae;
            color: #7a7d37;
            font-weight: bold;
        }
        
        .status-canceled {
            background-color: #afa8a8;
            color: #535353;
            font-weight: bold;
        }
        
        .chart-container {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            margin: 20px auto;
        }
        
        .chart-box {
            width: 45%;
            min-width: 300px;
            margin: 10px;
            padding: 10px;
        }
        
        .disabled-input {
            background-color: #f2f2f2;
            cursor: not-allowed;
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            height: 12px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 6px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #ff9b9b;
            border-radius: 6px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #ff0000;
        }
        
        .my-button {
            display: inline-block;
            padding: 10px 20px;
            background-color: #4285f4;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            margin: 10px;
            transition: background 0.3s;
            font-weight: bold;
        }
        
        .my-button:hover {
            background-color: #3367d6;
        }
        
        .green {
            background-color: #4CAF50;
        }
        
        .green:hover {
            background-color: #45a049;
        }
        
        /* New style for filled cells */
        .filled-cell {
            background-color: #ffffff !important;
        }
        
        .filled-input {
            background-color: #adff9b !important;
        }
        
        /* Delete button style */
        .delete-btn {
            background-color: #ff4444;
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
            font-size: 13px;
        }
        
        .delete-btn:hover {
            background-color: #cc0000;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Status PCR & SLA</h1>
            
        <!-- Container untuk Charts -->
        <div class="chart-container">
            <div class="chart-box">
                <canvas id="statusChart"></canvas>
            </div>
            <div class="chart-box">
                <canvas id="barChart"></canvas>
            </div>
        </div>
        <div class="catalog-container">
            <img src="Flow.png" alt="Flow" class="logo" width="500" height="100">
        </div>
        
        <!-- Table Container with Dual Scrollbars -->
        <div class="table-scroll-container">
            <div class="table-scroll-top">
                <div class="table-scroll-top-inner"></div>
            </div>
            <div class="table-container">
                <table id="dataTable">
                    <thead>
                        <tr>
                            <th>PCR/SLA Control No.</th>
                            <th>Date</th>  
                            <th>Supplier Name</th>
                            <th>Part Number</th>
                            <th>Part Name</th>
                            <th>Change Category</th>
                            <th>Prev. Process_________________________</th>
                            <th>New Process___________________________</th>
                            <th>Part Sample Received Date</th>
                            <th>Special Job Number</th>
                            <th>Trial Date</th>
                            <th>Report Trial Number</th>
                            <th>Judgement</th>
                            <th colspan="6">Mass Pro/implementation type</th>
                            <th>First E/G number</th>
                            <th>Status</th>
                            <th>Update Status</th>
                            <th>Notes (untuk menandai apabila pesan sudah dibaca/lain-lain)</th>
                            <th>Pesan dari pembuat Data</th>
                            <th>Delete</th>
                        </tr>
                        <tr>
                            <th></th>
                            <th></th>
                            <th></th>
                            <th></th>
                            <th></th>
                            <th></th>
                            <th></th>
                            <th></th>
                            <th></th>
                            <th></th>
                            <th></th>
                            <th></th>
                            <th></th>
                            <th>Supplier</th>
                            <th>P3 ETA</th>
                            <th>CEVD ETD</th>
                            <th>Importer ETA</th>
                            <th>First Module</th>
                            <th>TMMIN Line</th>
                            <th></th>
                            <th></th>
                            <th></th>
                            <th></th>
                            <th></th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
        </div>
        
        <p>Apabila ada kendala, segera sampaikan ke tim Quality Control</p>
        <div class="button-container">
            <a href="index.html" class="my-button">Kembali ke Home</a>
            <a href="view.html" class="my-button2"> </a>
            <a href="input.html" class="my-button">Masukan Data</a>
            <a href="view.html" class="my-button2"> </a>
            <a href="schedule.html" class="my-button">Lihat Jadwal</a>
            <a href="view.html" class="my-button2"> </a>
            <a href="https://docs.google.com/spreadsheets/d/157r2DA_9aEp_JQhzA15pPj2-GUnyKFJoaju-pw006M4/edit?usp=sharing" 
            class="my-button">SpreadSheets</a>
            
        </div>
    </div>

    <script>
        // Konfigurasi Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDB31VI5CjfiLPwD5njBa2tVHz_UXipNH0",
            authDomain: "pcr-sla-28728.firebaseapp.com",
            databaseURL: "https://pcr-sla-28728-default-rtdb.firebaseio.com",
            projectId: "pcr-sla-28728",
            storageBucket: "pcr-sla-28728.appspot.com",
            messagingSenderId: "738065802011",
            appId: "1:738065802011:web:28f865a4cb84a76f0a69be",
            measurementId: "G-NE5XL3LRJ8"
        };

        // Inisialisasi Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Referensi ke data di Firebase
        const dataRef = database.ref();

        // Variabel untuk chart
        let statusChart;
        let barChart;

        // Fungsi untuk membuat atau memperbarui charts
        function updateCharts(closedCount, ongoingCount, pcrCount, partDiterimaCount, specialJobCount, isrCount) {
            // Data untuk pie chart
            const pieData = {
                labels: ['Closed', 'Processed'],
                datasets: [{
                    data: [closedCount, ongoingCount],
                    backgroundColor: [
                        '#00bf63',
                        '#c1ff72',
                    ],
                }]
            };

            // Pie Chart
            const pieCtx = document.getElementById('statusChart').getContext('2d');
            if (statusChart) {
                statusChart.destroy();
            }
            statusChart = new Chart(pieCtx, {
                type: 'pie',
                data: pieData,
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'east',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = Math.round((value / total) * 100);
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        },
                        title: {
                            display: true,
                            text: 'Status Distribution'
                        }
                    }
                }
            });

            // Data untuk bar chart baru
            const barData = {
                labels: ['PCR', 'Part Diterima', 'Special Job', 'ISR'],
                datasets: [{
                    data: [pcrCount, partDiterimaCount, specialJobCount, isrCount],
                    backgroundColor: [
                        '#ff3131',
                        '#ff914d',
                        '#f9fbae',
                        '#00bf63'
                    ],
                }]
            };

            // Bar Chart
            const barCtx = document.getElementById('barChart').getContext('2d');
            if (barChart) {
                barChart.destroy();
            }
            barChart = new Chart(barCtx, {
                type: 'bar',
                data: barData,
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.label}: ${context.raw}`;
                                }
                            }
                        },
                        title: {
                            display: true,
                            text: 'Completion Tracker'
                        }
                    }
                }
            });
        }

        // Fungsi untuk memeriksa dan mengupdate status berdasarkan kolom yang diisi
        function updateStatusBasedOnColumns(key, item) {
            let newStatus = item.status || 'New';
            
            if (item.P && item.P.trim() !== '') {
                newStatus = 'Closed';
            } else if (item.M && item.M.trim() !== '') {
                newStatus = 'Wait for implementation';
            } else if (item.J && item.J.trim() !== '') {
                newStatus = 'Under Quality Confirmation';
            } else if (item.I && item.I.trim() !== '') {
                newStatus = 'Wait for OTS Part';
            }
            
            if (newStatus !== item.status) {
                database.ref(key + '/status').set(newStatus)
                    .catch((error) => {
                        console.error('Error updating status:', error);
                    });
            }
        }

        // Fungsi untuk menghapus record dari Firebase
        function deleteRecord(key) {
            if (confirm('Are you sure you want to delete this record?')) {
                database.ref(key).remove()
                    .then(() => {
                        alert('Record deleted successfully!');
                        loadData();
                    })
                    .catch((error) => {
                        alert('Error deleting record: ' + error.message);
                    });
            }
        }

        // Fungsi untuk memuat data ke tabel
        function loadData() {
            dataRef.on('value', (snapshot) => {
                const data = snapshot.val();
                const tableBody = document.querySelector('#dataTable tbody');
                tableBody.innerHTML = '';

                if (!data) {
                    updateCharts(0, 0, 0, 0, 0, 0);
                    return;
                }

                const dataArray = Object.entries(data);
                dataArray.sort((a, b) => b[0].localeCompare(a[0]));

                let closedCount = 0;
                let ongoingCount = 0;
                let pcrCount = 0;
                let partDiterimaCount = 0;
                let specialJobCount = 0;
                let isrCount = 0;

                dataArray.forEach(([key, item]) => {
                    const status = item.status || 'New';
                    
                    if (status === 'Closed') {
                        closedCount++;
                    } else if (status === 'Under Quality Confirmation' || 
                              status === 'Wait for OTS Part' || 
                              status === 'New' || 
                              status === 'Wait for implementation') {
                        ongoingCount++;
                    }
                    
                    if (['New', 'Closed', 'Under Quality Confirmation', 'Wait for OTS Part', 'Wait for implementation'].includes(status)) {
                        pcrCount++;
                    }
                    if (['Closed', 'Under Quality Confirmation', 'Wait for OTS Part', 'Wait for implementation'].includes(status)) {
                        partDiterimaCount++;
                    }
                    if (['Closed', 'Under Quality Confirmation', 'Wait for implementation'].includes(status)) {
                        specialJobCount++;
                    }
                    if (['Closed', 'Wait for implementation'].includes(status)) {
                        isrCount++;
                    }
                    
                    const row = document.createElement('tr');
                    
                    // PCR/SLA Control No. - Input Text
                    const cellControlNo = document.createElement('td');
                    const inputB = document.createElement('input');
                    inputB.type = 'text';
                    inputB.className = 'edit-input';
                    inputB.value = item.B || '';
                    if (item.B && item.B.trim() !== '') {
                        inputB.classList.add('filled-input');
                    }
                    inputB.addEventListener('change', function() {
                        updateColumn(key, 'B', inputB.value);
                        if (inputB.value.trim() !== '') {
                            inputB.classList.add('filled-input');
                        } else {
                            inputB.classList.remove('filled-input');
                        }
                    });
                    cellControlNo.appendChild(inputB);
                    row.appendChild(cellControlNo);
                    
                    // Date - Tetap text biasa karena ini key
                    const cellDate = document.createElement('td');
                    const inputA = document.createElement('input');
                    cellDate.textContent = key || '-';
                    if (key && key.trim() !== '') {
                        cellDate.classList.add('filled-cell');
                    }
                    row.appendChild(cellDate);
                    
                    // Supplier Name - Input Text
                    const cellC = document.createElement('td');
                    const selectC = document.createElement('select');
                    selectC.className = 'edit-select';
                    selectC.value = item.C || '';
                    if (item.C && item.C.trim() !== '') {
                        selectC.classList.add('filled-input');
                    }

                    const optionC1 = document.createElement('option');
                    optionC1.value = 'AISAN NASMOCO INDUSTRI';
                    optionC1.textContent = 'AISAN NASMOCO INDUSTRI';
                    selectC.appendChild(optionC1);

                    const optionC2 = document.createElement('option');
                    optionC2.value = 'AISIN INDONESIA';
                    optionC2.textContent = 'AISIN INDONESIA';
                    selectC.appendChild(optionC2);

                    const optionC3 = document.createElement('option');
                    optionC3.value = 'AISIN INDONESIA OTOMOTIF';
                    optionC3.textContent = 'AISIN INDONESIA OTOMOTIF';
                    selectC.appendChild(optionC3);

                    const optionC4 = document.createElement('option');
                    optionC4.value = 'AOYAMA INDONESIA';
                    optionC4.textContent = 'AOYAMA INDONESIA';
                    selectC.appendChild(optionC4);

                    const optionC5 = document.createElement('option');
                    optionC5.value = 'ART PISTON INDONESIA';
                    optionC5.textContent = 'ART PISTON INDONESIA';
                    selectC.appendChild(optionC5);

                    const optionC6 = document.createElement('option');
                    optionC6.value = 'ASSB MALAYSIA';
                    optionC6.textContent = 'ASSB MALAYSIA';
                    selectC.appendChild(optionC6);

                    const optionC7 = document.createElement('option');
                    optionC7.value = 'ASTRA NIPPON GASKET INDONESIA';
                    optionC7.textContent = 'ASTRA NIPPON GASKET INDONESIA';
                    selectC.appendChild(optionC7);

                    const optionC8 = document.createElement('option');
                    optionC8.value = 'AT INDONESIA';
                    optionC8.textContent = 'AT INDONESIA';
                    selectC.appendChild(optionC8);

                    const optionC9 = document.createElement('option');
                    optionC9.value = 'AUTOMOTIVE FASTENERS AOYAMA INDONESIA';
                    optionC9.textContent = 'AUTOMOTIVE FASTENERS AOYAMA INDONESIA';
                    selectC.appendChild(optionC9);

                    const optionC10 = document.createElement('option');
                    optionC10.value = 'CATALER';
                    optionC10.textContent = 'CATALER';
                    selectC.appendChild(optionC10);

                    const optionC11 = document.createElement('option');
                    optionC11.value = 'DENSO INDONESIA CORPORATION (FAJAR)';
                    optionC11.textContent = 'DENSO INDONESIA CORPORATION (FAJAR)';
                    selectC.appendChild(optionC11);

                    const optionC12 = document.createElement('option');
                    optionC12.value = 'DIAMOND DELECTRIC INDONESIA';
                    optionC12.textContent = 'DIAMOND DELECTRIC INDONESIA';
                    selectC.appendChild(optionC12);

                    const optionC13 = document.createElement('option');
                    optionC13.value = 'FUKOKU TOKAI RUBBER';
                    optionC13.textContent = 'FUKOKU TOKAI RUBBER';
                    selectC.appendChild(optionC13);

                    const optionC14 = document.createElement('option');
                    optionC14.value = 'FUTABA INDONESIA';
                    optionC14.textContent = 'FUTABA INDONESIA';
                    selectC.appendChild(optionC14);

                    const optionC15 = document.createElement('option');
                    optionC15.value = 'HITACHI';
                    optionC15.textContent = 'HITACHI';
                    selectC.appendChild(optionC15);

                    const optionC16 = document.createElement('option');
                    optionC16.value = 'ITOKIN';
                    optionC16.textContent = 'ITOKIN';
                    selectC.appendChild(optionC16);

                    const optionC17 = document.createElement('option');
                    optionC17.value = 'METALART ASTRA INDONESIA';
                    optionC17.textContent = 'METALART ASTRA INDONESIA';
                    selectC.appendChild(optionC17);

                    const optionC18 = document.createElement('option');
                    optionC18.value = 'NICHIAS SUNIJAYA';
                    optionC18.textContent = 'NICHIAS SUNIJAYA';
                    selectC.appendChild(optionC18);

                    const optionC19 = document.createElement('option');
                    optionC19.value = 'NOK INDONESIA';
                    optionC19.textContent = 'NOK INDONESIA';
                    selectC.appendChild(optionC19);

                    const optionC20 = document.createElement('option');
                    optionC20.value = 'OTICS INDONESIA';
                    optionC20.textContent = 'OTICS INDONESIA';
                    selectC.appendChild(optionC20);

                    const optionC21 = document.createElement('option');
                    optionC21.value = 'PAKAR TIRIKEN INDONESIA';
                    optionC21.textContent = 'PAKAR TIRIKEN INDONESIA';
                    selectC.appendChild(optionC21);

                    const optionC22 = document.createElement('option');
                    optionC22.value = 'PARIN';
                    optionC22.textContent = 'PARIN';
                    selectC.appendChild(optionC22);

                    const optionC23 = document.createElement('option');
                    optionC23.value = 'PATEC PRESISI ENGINEERING';
                    optionC23.textContent = 'PATEC PRESISI ENGINEERING';
                    selectC.appendChild(optionC23);

                    const optionC24 = document.createElement('option');
                    optionC24.value = 'ROBERT BOSCH';
                    optionC24.textContent = 'ROBERT BOSCH';
                    selectC.appendChild(optionC24);

                    const optionC25 = document.createElement('option');
                    optionC25.value = 'SARI TAKAGI ELOK PRODUK';
                    optionC25.textContent = 'SARI TAKAGI ELOK PRODUK';
                    selectC.appendChild(optionC25);

                    const optionC26 = document.createElement('option');
                    optionC26.value = 'SIAM THAILAND MOTOR';
                    optionC26.textContent = 'SIAM THAILAND MOTOR';
                    selectC.appendChild(optionC26);

                    const optionC27 = document.createElement('option');
                    optionC27.value = 'SUMIDEN SINTERED COMPONENT INDONESIA';
                    optionC27.textContent = 'SUMIDEN SINTERED COMPONENT INDONESIA';
                    selectC.appendChild(optionC27);

                    const optionC28 = document.createElement('option');
                    optionC28.value = 'SUNCHIRIN INDUSTRI INDONESIA';
                    optionC28.textContent = 'SUNCHIRIN INDUSTRI INDONESIA';
                    selectC.appendChild(optionC28);

                    const optionC29 = document.createElement('option');
                    optionC29.value = 'TAIHO NUSANTARA';
                    optionC29.textContent = 'TAIHO NUSANTARA';
                    selectC.appendChild(optionC29);

                    const optionC30 = document.createElement('option');
                    optionC30.value = 'TB-INA';
                    optionC30.textContent = 'TB-INA';
                    selectC.appendChild(optionC30);

                    const optionC31 = document.createElement('option');
                    optionC31.value = 'TOYOTA BOSHOKU INDONESIA';
                    optionC31.textContent = 'TOYOTA BOSHOKU INDONESIA';
                    selectC.appendChild(optionC31);

                    const optionC32 = document.createElement('option');
                    optionC32.value = 'TPR SALES INDONESIA';
                    optionC32.textContent = 'TPR SALES INDONESIA';
                    selectC.appendChild(optionC32);

                    const optionC33 = document.createElement('option');
                    optionC33.value = 'IVELASTO INDONESIA';
                    optionC33.textContent = 'IVELASTO INDONESIA';
                    selectC.appendChild(optionC33);

                    const optionC34 = document.createElement('option');
                    optionC34.value = 'YASUNAGA INDONESIA';
                    optionC34.textContent = 'YASUNAGA INDONESIA';
                    selectC.appendChild(optionC34);

                    const optionC35 = document.createElement('option');
                    optionC35.value = '#NA';
                    optionC35.textContent = '#NA';
                    selectC.appendChild(optionC35);

                    if (item.C) {
                        selectC.value = item.C;
                    }

                    selectC.addEventListener('change', function() {
                        updateColumn(key, 'C', selectC.value);
                        updateStatusBasedOnColumns(key, {...item, C: selectC.value});
                        if (selectC.value.trim() !== '') {
                            selectC.classList.add('filled-input');
                        } else {
                            selectC.classList.remove('filled-input');
                        }
                    });
                    cellC.appendChild(selectC);
                    row.appendChild(cellC);
                    
                    // Part Number - Input Text
                    const cellPartNo = document.createElement('td');
                    const inputD = document.createElement('input');
                    inputD.type = 'text';
                    inputD.className = 'edit-input';
                    inputD.value = item.D || '';
                    if (item.D && item.D.trim() !== '') {
                        inputD.classList.add('filled-input');
                    }
                    inputD.addEventListener('change', function() {
                        updateColumn(key, 'D', inputD.value);
                        if (inputD.value.trim() !== '') {
                            inputD.classList.add('filled-input');
                        } else {
                            inputD.classList.remove('filled-input');
                        }
                    });
                    cellPartNo.appendChild(inputD);
                    row.appendChild(cellPartNo);
                    
                    // Part Name - Input Text
                    const cellPartName = document.createElement('td');
                    const inputE = document.createElement('input');
                    inputE.type = 'text';
                    inputE.className = 'edit-input';
                    inputE.value = item.E || '';
                    if (item.E && item.E.trim() !== '') {
                        inputE.classList.add('filled-input');
                    }
                    inputE.addEventListener('change', function() {
                        updateColumn(key, 'E', inputE.value);
                        if (inputE.value.trim() !== '') {
                            inputE.classList.add('filled-input');
                        } else {
                            inputE.classList.remove('filled-input');
                        }
                    });
                    cellPartName.appendChild(inputE);
                    row.appendChild(cellPartName);
                    
                    // Change Category - Input Text
                    const cellF = document.createElement('td');
                    const selectF = document.createElement('select');
                    selectF.className = 'edit-select';
                    selectF.value = item.F || '';
                    if (item.F && item.F.trim() !== '') {
                        selectF.classList.add('filled-input');
                    }

                    const optionF1 = document.createElement('option');
                    optionF1.value = 'Add Supplier';
                    optionF1.textContent = 'Add Supplier';
                    selectF.appendChild(optionF1);

                    const optionF2 = document.createElement('option');
                    optionF2.value = 'Capacity';
                    optionF2.textContent = 'Capacity';
                    selectF.appendChild(optionF2);

                    const optionF3 = document.createElement('option');
                    optionF3.value = 'Change Supplier';
                    optionF3.textContent = 'Change Supplier';
                    selectF.appendChild(optionF3);

                    const optionF4 = document.createElement('option');
                    optionF4.value = 'Cost';
                    optionF4.textContent = 'Cost';
                    selectF.appendChild(optionF4);

                    const optionF5 = document.createElement('option');
                    optionF5.value = 'Govt Regulation';
                    optionF5.textContent = 'Govt Regulation';
                    selectF.appendChild(optionF5);

                    const optionF6 = document.createElement('option');
                    optionF6.valUe = 'Localization';
                    optionF6.textContent = 'Localization';
                    selectF.appendChild(optionF6);

                    const optionF7 = document.createElement('option');
                    optionF7.value = 'Mfg/Storage Loc';
                    optionF7.textContent = 'Mfg/Storage Loc';
                    selectF.appendChild(optionF7);

                    const optionF8 = document.createElement('option');
                    optionF8.value = 'Productivity';
                    optionF8.textContent = 'Productivity';
                    selectF.appendChild(optionF8);

                    const optionF9 = document.createElement('option');
                    optionF9.value = 'Quality';
                    optionF9.textContent = 'Quality';
                    selectF.appendChild(optionF9);

                    const optionF10 = document.createElement('option');
                    optionF10.value = 'Risk Mgmt';
                    optionF10.textContent = 'Risk Mgmt';
                    selectF.appendChild(optionF10);

                    const optionF11 = document.createElement('option');
                    optionF11.value = 'Other';
                    optionF11.textContent = 'Other';
                    selectF.appendChild(optionF11);

                    if (item.F) {
                        selectF.value = item.F;
                    }

                    selectF.addEventListener('change', function() {
                        updateColumn(key, 'F', selectF.value);
                        updateStatusBasedOnColumns(key, {...item, F: selectF.value});
                        if (selectF.value.trim() !== '') {
                            selectF.classList.add('filled-input');
                        } else {
                            selectF.classList.remove('filled-input');
                        }
                    });
                    cellF.appendChild(selectF);
                    row.appendChild(cellF);
                    
                    // Prev. Process - Input Text
                    const cellPrevProcess = document.createElement('td');
                    const inputG = document.createElement('input');
                    inputG.type = 'text';
                    inputG.className = 'edit-input';
                    inputG.value = item.G || '';
                    if (item.G && item.G.trim() !== '') {
                        inputG.classList.add('filled-input');
                    }
                    inputG.addEventListener('change', function() {
                        updateColumn(key, 'G', inputG.value);
                        if (inputG.value.trim() !== '') {
                            inputG.classList.add('filled-input');
                        } else {
                            inputG.classList.remove('filled-input');
                        }
                    });
                    cellPrevProcess.appendChild(inputG);
                    row.appendChild(cellPrevProcess);
                    
                    // New Process - Input Text
                    const cellNewProcess = document.createElement('td');
                    const inputH = document.createElement('input');
                    inputH.type = 'text';
                    inputH.className = 'edit-input';
                    inputH.value = item.H || '';
                    if (item.H && item.H.trim() !== '') {
                        inputH.classList.add('filled-input');
                    }
                    inputH.addEventListener('change', function() {
                        updateColumn(key, 'H', inputH.value);
                        if (inputH.value.trim() !== '') {
                            inputH.classList.add('filled-input');
                        } else {
                            inputH.classList.remove('filled-input');
                        }
                    });
                    cellNewProcess.appendChild(inputH);
                    row.appendChild(cellNewProcess);
                    
                    // ... (bagian kolom-kolom berikutnya tetap sama seperti sebelumnya) ...
                    
                    // Column I - Part Sample Received Date
                    const cellColumnI = document.createElement('td');
                    const inputI = document.createElement('input');
                    inputI.type = 'date';
                    inputI.className = 'edit-input';
                    inputI.value = item.I ? item.I.replace(/\//g, '-') : '';
                    if (item.I && item.I.trim() !== '') {
                        inputI.classList.add('filled-input');
                    }
                    inputI.addEventListener('change', function() {
                        const dateValue = this.value.replace(/-/g, '/');
                        updateColumn(key, 'I', dateValue);
                        updateColumnDependencies(row, item);
                        if (dateValue.trim() !== '') {
                            inputI.classList.add('filled-input');
                        } else {
                            inputI.classList.remove('filled-input');
                        }
                    });
                    cellColumnI.appendChild(inputI);
                    row.appendChild(cellColumnI);
                    
                    // Column J - Special Job Number
                    const cellColumnJ = document.createElement('td');
                    const inputJ = document.createElement('input');
                    inputJ.type = 'text';
                    inputJ.className = 'edit-input';
                    inputJ.value = item.J || '';
                    if (item.J && item.J.trim() !== '') {
                        inputJ.classList.add('filled-input');
                    }
                    if (!item.I || item.I.trim() === '') {
                        inputJ.disabled = true;
                        inputJ.classList.add('disabled-input');
                    }
                    inputJ.addEventListener('change', function() {
                        updateColumn(key, 'J', inputJ.value);
                        updateStatusBasedOnColumns(key, {...item, J: inputJ.value});
                        updateColumnDependencies(row, item);
                        if (inputJ.value.trim() !== '') {
                            inputJ.classList.add('filled-input');
                        } else {
                            inputJ.classList.remove('filled-input');
                        }
                    });
                    cellColumnJ.appendChild(inputJ);
                    row.appendChild(cellColumnJ);
                    
                    // Column K - Trial Date
                    const cellColumnK = document.createElement('td');
                    const inputK = document.createElement('input');
                    inputK.type = 'date';
                    inputK.className = 'edit-input';
                    inputK.value = item.K ? item.K.replace(/\//g, '-') : '';
                    if (item.K && item.K.trim() !== '') {
                        inputK.classList.add('filled-input');
                    }
                    if (!item.J || item.J.trim() === '') {
                        inputK.disabled = true;
                        inputK.classList.add('disabled-input');
                    }
                    inputK.addEventListener('change', function() {
                        const dateValue = this.value.replace(/-/g, '/');
                        updateColumn(key, 'K', dateValue);
                        updateColumnDependencies(row, item);
                        if (dateValue.trim() !== '') {
                            inputK.classList.add('filled-input');
                        } else {
                            inputK.classList.remove('filled-input');
                        }
                    });
                    cellColumnK.appendChild(inputK);
                    row.appendChild(cellColumnK);
                    
                    // Column L - Report Trial Number
                    const cellColumnL = document.createElement('td');
                    const inputL = document.createElement('input');
                    inputL.type = 'text';
                    inputL.className = 'edit-input';
                    inputL.value = item.L || '';
                    if (item.L && item.L.trim() !== '') {
                        inputL.classList.add('filled-input');
                    }
                    if (!item.K || item.K.trim() === '') {
                        inputL.disabled = true;
                        inputL.classList.add('disabled-input');
                    }
                    inputL.addEventListener('change', function() {
                        updateColumn(key, 'L', inputL.value);
                        updateColumnDependencies(row, item);
                        if (inputL.value.trim() !== '') {
                            inputL.classList.add('filled-input');
                        } else {
                            inputL.classList.remove('filled-input');
                        }
                    });
                    cellColumnL.appendChild(inputL);
                    row.appendChild(cellColumnL);
                    
                    // Column M - Judgement (select)
                    const cellColumnM = document.createElement('td');
                    const selectM = document.createElement('select');
                    selectM.className = 'edit-select';
                    selectM.value = item.M || '';
                    if (item.M && item.M.trim() !== '') {
                        selectM.classList.add('filled-input');
                    }

                    const optionMDefault = document.createElement('option');
                    optionMDefault.value = '';
                    optionMDefault.textContent = 'Select Judgement';
                    selectM.appendChild(optionMDefault);

                    const optionMOK = document.createElement('option');
                    optionMOK.value = 'OK';
                    optionMOK.textContent = 'OK';
                    selectM.appendChild(optionMOK);

                    const optionMNG = document.createElement('option');
                    optionMNG.value = 'NG';
                    optionMNG.textContent = 'NG';
                    selectM.appendChild(optionMNG);

                    if (item.M) {
                        selectM.value = item.M;
                    }

                    if (!item.L || item.L.trim() === '') {
                        selectM.disabled = true;
                        selectM.classList.add('disabled-input');
                    }

                    selectM.addEventListener('change', function() {
                        updateColumn(key, 'M', selectM.value);
                        updateStatusBasedOnColumns(key, {...item, M: selectM.value});
                        updateColumnDependencies(row, item);
                        if (selectM.value.trim() !== '') {
                            selectM.classList.add('filled-input');
                        } else {
                            selectM.classList.remove('filled-input');
                        }
                    });
                    cellColumnM.appendChild(selectM);
                    row.appendChild(cellColumnM);

                    // 6 Sub-columns for Mass Pro Dates (MPA-MPF)
                    const massProLetters = ['A', 'B', 'C', 'D', 'E', 'F'];
                    massProLetters.forEach(letter => {
                        const cellColumn = document.createElement('td');
                        const inputDate = document.createElement('input');
                        inputDate.type = 'date';
                        inputDate.className = 'edit-input';
                        const fieldName = 'MP' + letter;
                        inputDate.value = item[fieldName] ? item[fieldName].replace(/\//g, '-') : '';
                        if (item[fieldName] && item[fieldName].trim() !== '') {
                            inputDate.classList.add('filled-input');
                        }
                        
                        if (!item.M || item.M.trim() === '') {
                            inputDate.disabled = true;
                            inputDate.classList.add('disabled-input');
                        }
                        
                        inputDate.addEventListener('change', function() {
                            const dateValue = this.value.replace(/-/g, '/');
                            updateColumn(key, fieldName, dateValue);
                            updateStatusBasedOnColumns(key, {...item, [fieldName]: dateValue});
                            if (dateValue.trim() !== '') {
                                inputDate.classList.add('filled-input');
                            } else {
                                inputDate.classList.remove('filled-input');
                            }
                        });
                        
                        cellColumn.appendChild(inputDate);
                        row.appendChild(cellColumn);
                    });

                    // Column P - First E/G number
                    const cellColumnP = document.createElement('td');
                    const inputP = document.createElement('input');
                    inputP.type = 'text';
                    inputP.className = 'edit-input';
                    inputP.value = item.P || '';
                    if (item.P && item.P.trim() !== '') {
                        inputP.classList.add('filled-input');
                    }
                    const anyMPFilled = massProLetters.some(letter => item['MP' + letter]);
                    if (!anyMPFilled) {
                        inputP.disabled = true;
                        inputP.classList.add('disabled-input');
                    }
                    inputP.addEventListener('change', function() {
                        updateColumn(key, 'P', inputP.value);
                        updateStatusBasedOnColumns(key, {...item, P: inputP.value});
                        if (inputP.value.trim() !== '') {
                            inputP.classList.add('filled-input');
                        } else {
                            inputP.classList.remove('filled-input');
                        }
                    });
                    cellColumnP.appendChild(inputP);
                    row.appendChild(cellColumnP);
                    
                    // Status
                    const cellStatus = document.createElement('td');
                    cellStatus.textContent = item.status || 'New';
                    if (item.status === 'Closed') {
                        cellStatus.classList.add('status-done');
                    } else if (item.status === 'Under Quality Confirmation' || 
                              item.status === 'Wait for OTS Part' || 
                              item.status === 'Wait for implementation') {
                        cellStatus.classList.add('status-ongoing');
                    } else if (item.status === 'Canceled') {
                        cellStatus.classList.add('status-canceled');
                    } else {
                        cellStatus.classList.add('status-new');
                    }
                    row.appendChild(cellStatus);
                    
                    // Update Status
                    const cellUpdate = document.createElement('td');
                    
                    const select = document.createElement('select');
                    select.className = 'edit-select';
                    
                    const optionDefault = document.createElement('option');
                    optionDefault.value = '';
                    optionDefault.textContent = 'Select status';
                    select.appendChild(optionDefault);

                    const optionWait = document.createElement('option');
                    optionWait.value = 'Wait for OTS Part';
                    optionWait.textContent = 'Wait for OTS Part';
                    select.appendChild(optionWait);

                    const optionCanceled = document.createElement('option');
                    optionCanceled.value = 'Canceled';
                    optionCanceled.textContent = 'Canceled';
                    select.appendChild(optionCanceled);

                    const optionClosed = document.createElement('option');
                    optionClosed.value = 'Closed';
                    optionClosed.textContent = 'Closed';
                    select.appendChild(optionClosed);
                    
                    if (item.status) {
                        select.value = item.status;
                    }
                    
                    const saveBtn = document.createElement('button');
                    saveBtn.className = 'save-btn';
                    saveBtn.textContent = 'Update';
                    saveBtn.onclick = function() {
                        updateStatus(key, select.value);
                    };
                    
                    cellUpdate.appendChild(select);
                    cellUpdate.appendChild(saveBtn);
                    row.appendChild(cellUpdate);
                    
                    // Notes
                    const cellColumnNotes = document.createElement('td');
                    const inputNotes = document.createElement('input');
                    inputNotes.type = 'text';
                    inputNotes.className = 'edit-input';
                    inputNotes.value = item.notes || '';
                    if (item.notes && item.notes.trim() !== '') {
                        inputNotes.classList.add('filled-input');
                    }
                    inputNotes.addEventListener('change', function() {
                        updateColumn(key, 'notes', inputNotes.value);
                        if (inputNotes.value.trim() !== '') {
                            inputNotes.classList.add('filled-input');
                        } else {
                            inputNotes.classList.remove('filled-input');
                        }
                    });
                    cellColumnNotes.appendChild(inputNotes);
                    row.appendChild(cellColumnNotes);

                    // Action baca pesan pembuat data 
                    const cellPesan = document.createElement('td');
                    cellPesan.textContent = item.notes2 || '-';
                    if (item.notes2 && item.notes2.trim() !== '') {
                        cellPesan.classList.add('filled-cell');
                    }
                    row.appendChild(cellPesan);

                    // Action Column - Delete Button
                    const cellAction = document.createElement('td');
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'delete-btn';
                    deleteBtn.textContent = 'Delete';
                    deleteBtn.onclick = function() {
                        deleteRecord(key);
                    };
                    cellAction.appendChild(deleteBtn);
                    row.appendChild(cellAction);

                    tableBody.appendChild(row);
                });

                updateCharts(closedCount, ongoingCount, pcrCount, partDiterimaCount, specialJobCount, isrCount);
                syncScrollBars();
            });
        }

        // Fungsi untuk mengupdate dependencies kolom
        function updateColumnDependencies(row, item) {
            const inputs = row.querySelectorAll('.edit-input');
            const selects = row.querySelectorAll('.edit-select');
            
            const allFields = Array.from(inputs).concat(Array.from(selects));
            
            allFields.sort((a, b) => {
                return a.closest('td').cellIndex - b.closest('td').cellIndex;
            });
            
            for (let i = 1; i < allFields.length; i++) {
                const prevField = allFields[i-1];
                const currentField = allFields[i];
                
                if (currentField.id && currentField.id.includes('MP')) continue;
                
                if (prevField.value && prevField.value.trim() === '' && 
                    !(prevField.tagName === 'SELECT' && prevField.value === '')) {
                    currentField.value = '';
                    currentField.disabled = true;
                    currentField.classList.add('disabled-input');
                } else {
                    currentField.disabled = false;
                    currentField.classList.remove('disabled-input');
                }
            }
            
            const judgementSelect = row.querySelector('td:nth-child(14) select');
            const mpInputs = row.querySelectorAll('td:nth-child(15), td:nth-child(16), td:nth-child(17), td:nth-child(18), td:nth-child(19), td:nth-child(20) input');
            
            if (judgementSelect && judgementSelect.value.trim() === '') {
                mpInputs.forEach(input => {
                    input.value = '';
                    input.disabled = true;
                    input.classList.add('disabled-input');
                });
            } else {
                mpInputs.forEach(input => {
                    input.disabled = false;
                    input.classList.remove('disabled-input');
                });
            }
            
            const firstEGInput = row.querySelector('td:nth-child(21) input');
            if (firstEGInput) {
                const anyMPFilled = Array.from(mpInputs).some(input => input.value.trim() !== '');
                if (!anyMPFilled) {
                    firstEGInput.value = '';
                    firstEGInput.disabled = true;
                    firstEGInput.classList.add('disabled-input');
                } else {
                    firstEGInput.disabled = false;
                    firstEGInput.classList.remove('disabled-input');
                }
            }
        }

        // Fungsi untuk mengupdate kolom di Firebase
        function updateColumn(key, column, value) {
            database.ref(key + '/' + column).set(value)
                .catch((error) => {
                    console.error('Error updating column:', error);
                });
        }

        // Fungsi untuk mengupdate status di Firebase
        function updateStatus(key, newStatus) {
            if (!newStatus) {
                alert('Please select a status!');
                return;
            }
            
            if (newStatus === 'Canceled') {
                if (confirm('Are you sure you want to cancel this record? This will clear data from Part Sample Received Date onwards.')) {
                    const updates = {};
                    updates[`${key}/status`] = 'Canceled';
                    
                    const columnsToClear = ['I', 'J', 'K', 'L', 'M', 'MPA', 'MPB', 'MPC', 'MPD', 'MPE', 'MPF', 'P', 'notes'];
                    
                    columnsToClear.forEach(col => {
                        updates[`${key}/${col}`] = '';
                    });
                    
                    database.ref().update(updates)
                        .then(() => {
                            alert('Status updated to Canceled and related data cleared!');
                            loadData();
                        })
                        .catch((error) => {
                            alert('Error updating status: ' + error.message);
                        });
                }
            } else {
                database.ref(key + '/status').set(newStatus)
                    .then(() => {
                        alert('Status updated successfully!');
                        loadData();
                    })
                    .catch((error) => {
                        alert('Error updating status: ' + error.message);
                    });
            }
        }
        
        // Fungsi untuk sinkronisasi scroll bar
        function syncScrollBars() {
            const tableContainer = document.querySelector('.table-container');
            const tableScrollTop = document.querySelector('.table-scroll-top');
            const table = document.querySelector('#dataTable');
            
            if (tableContainer && tableScrollTop && table) {
                const tableScrollTopInner = document.querySelector('.table-scroll-top-inner');
                tableScrollTopInner.style.width = table.scrollWidth + 'px';
                
                tableContainer.addEventListener('scroll', function() {
                    tableScrollTop.scrollLeft = this.scrollLeft;
                });
                
                tableScrollTop.addEventListener('scroll', function() {
                    tableContainer.scrollLeft = this.scrollLeft;
                });
            }
        }


        // Muat data saat halaman dimuat
        window.onload = function() {
            loadData();
        };
    </script>
</body>
</html>